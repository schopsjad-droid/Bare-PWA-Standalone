rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() { return request.auth != null; }
    
    // Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratingSum', 'ratingCount']));
      match /reviews/{reviewId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.reviewerId == request.auth.uid;
      }
    }

    // Ads Collection
    match /ads/{adId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (request.auth.uid == resource.data.userId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']));
      // Admin Delete Permission
      allow delete: if request.auth.uid == resource.data.userId || request.auth.token.email == 'schops.jad@gmail.com';
    }

    // Chats Collection (FINAL FIX)
    match /chats/{chatId} {
      // Allow creation if auth user is in participants list
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      
      // FIXED: Allow read for:
      // 1. Existing participants (for single doc reads)
      // 2. List queries where user is buyerId or sellerId (for checking existing chats)
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participants ||
        resource.data.buyerId == request.auth.uid ||
        resource.data.sellerId == request.auth.uid
      );
      
      // Allow update for existing participants
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;

      match /messages/{messageId} {
        // Read: Strict check on parent chat participants
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Create: Allow if user is sender
        allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
        
        // Update: Allow for read-receipts
        allow update: if isAuthenticated();
      }
    }

    // Other Collections
    match /reports/{reportId} {
      allow create: if isAuthenticated() && request.resource.data.reporterId == request.auth.uid;
    }
    match /favorites/{favoriteId} {
      allow read, write: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    match /{document=**} { allow read, write: if false; }
  }
}
