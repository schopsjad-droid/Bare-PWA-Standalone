rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // Helper Functions
    // ========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user has a valid username (not default)
    function hasValidUsername() {
      return isAuthenticated() 
        && request.resource.data.username != null 
        && request.resource.data.username != 'مستخدم'
        && request.resource.data.username != '';
    }
    
    // Check if user is a participant in a chat
    function isChatParticipant(chatId) {
      return isAuthenticated() 
        && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
    
    // ========================================
    // Users Collection
    // ========================================
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for seller profiles)
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId;
      
      // Users can only update their own profile
      // Allow system to update rating fields (ratingSum, ratingCount)
      allow update: if isOwner(userId)
                    || (isAuthenticated() 
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratingSum', 'ratingCount']));
      
      // Users cannot delete their own profile
      allow delete: if false;
      
      // Reviews subcollection
      match /reviews/{reviewId} {
        // Anyone authenticated can read reviews
        allow read: if isAuthenticated();
        
        // Authenticated users can create reviews (but not for themselves)
        allow create: if isAuthenticated()
                      && request.resource.data.reviewerId == request.auth.uid
                      && request.auth.uid != userId;
        
        // No updates or deletes on reviews
        allow update, delete: if false;
      }
    }
    
    // ========================================
    // Ads Collection
    // ========================================
    match /ads/{adId} {
      // Anyone can read ads (public access)
      allow read: if true;
      
      // Authenticated users with valid username can create ads
      allow create: if isAuthenticated()
                    && hasValidUsername()
                    && request.resource.data.userId == request.auth.uid;
      
      // Only the owner can update their ad
      // Allow system to increment views counter
      allow update: if isAuthenticated() 
                    && request.auth.uid == resource.data.userId
                    || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']));
      
      // Only the owner can delete their ad
      allow delete: if isAuthenticated() 
                    && request.auth.uid == resource.data.userId;
    }
    
    // ========================================
    // Chats Collection
    // ========================================
    match /chats/{chatId} {
      // Only participants can read the chat
      allow read: if isAuthenticated() 
                  && request.auth.uid in resource.data.participants;
      
      // Authenticated users can create chats
      allow create: if isAuthenticated()
                    && request.auth.uid in request.resource.data.participants;
      
      // Participants can update chat metadata (lastMessage, lastMessageTime)
      allow update: if isAuthenticated() 
                    && request.auth.uid in resource.data.participants;
      
      // No one can delete chats
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Only chat participants can read messages
        allow read: if isChatParticipant(chatId);
        
        // Only chat participants can create messages
        allow create: if isChatParticipant(chatId)
                      && request.resource.data.senderId == request.auth.uid;
        
        // No updates or deletes on messages
        allow update, delete: if false;
      }
    }
    
    // ========================================
    // Reports Collection
    // ========================================
    match /reports/{reportId} {
      // Only admins can read reports (for now, no one can read)
      allow read: if false;
      
      // Authenticated users can create reports
      allow create: if isAuthenticated()
                    && request.resource.data.reporterId == request.auth.uid;
      
      // No updates or deletes on reports
      allow update, delete: if false;
    }
    
    // ========================================
    // Favorites Collection (if using separate collection)
    // ========================================
    match /favorites/{favoriteId} {
      // Users can only read their own favorites
      allow read: if isAuthenticated() 
                  && request.auth.uid == resource.data.userId;
      
      // Users can create their own favorites
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own favorites
      allow delete: if isAuthenticated() 
                    && request.auth.uid == resource.data.userId;
      
      // No updates on favorites
      allow update: if false;
    }
    
    // ========================================
    // Deny All Other Access
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
